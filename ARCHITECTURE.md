# Архитектура WhatsApp Stream Crypto

## Общий обзор

Библиотека реализует потоковое шифрование и расшифровку медиа файлов в формате, совместимом с WhatsApp. Основные компоненты:

1. **CryptoManager** - управляет криптографическими операциями
2. **DecryptingStream** - поток для расшифровки данных
3. **EncryptingStream** - поток для шифрования данных
4. **MediaType** - типы поддерживаемых медиа файлов

## Криптографические операции

### Расширение ключа (HKDF)

1. Входные данные:
   - mediaKey (32 байта)
   - тип медиа (для контекстной информации)

2. Процесс:
   - HKDF Extract с нулевой солью
   - HKDF Expand с типом медиа как info
   - Результат: 112 байт (IV + cipherKey + macKey + refKey)

3. Компоненты расширенного ключа:
   - IV (16 байт) - вектор инициализации
   - cipherKey (32 байта) - ключ шифрования
   - macKey (32 байта) - ключ для MAC
   - refKey (32 байта) - не используется

### Шифрование (AES-256-CBC)

1. Параметры:
   - Алгоритм: AES-256-CBC
   - Размер блока: 16 байт
   - Размер ключа: 32 байта
   - Паддинг: PKCS7

2. Процесс:
   - Первый блок: используется IV из расширенного ключа
   - Последующие блоки: IV = последний блок шифртекста
   - Последний блок: добавляется PKCS7 паддинг

### Проверка целостности (HMAC-SHA256)

1. MAC для всего файла:
   - Данные: IV + зашифрованные данные
   - Ключ: macKey из расширенного ключа
   - Результат: первые 10 байт от HMAC-SHA256

2. MAC для чанков (sidecar):
   - Размер чанка: 64KB
   - MAC для каждого чанка отдельно
   - Конкатенация всех MAC'ов

## Потоковая обработка

### Размеры буферов и чанков

1. Чтение/запись:
   - Размер чанка: 64KB
   - Буфер потока: динамический

2. Особенности:
   - Минимальное использование памяти
   - Эффективная работа с большими файлами
   - Поддержка произвольного доступа

### Sidecar файлы

1. Назначение:
   - Потоковое воспроизведение
   - Проверка целостности по чанкам
   - Возможность начать воспроизведение до полной загрузки

2. Структура:
   - Последовательность MAC'ов (по 10 байт)
   - Каждый MAC соответствует чанку 64KB
   - Последний MAC может быть для неполного чанка

## Тестирование

### Функциональные тесты

1. DecryptionTest:
   - Расшифровка тестовых файлов
   - Проверка размеров и хешей
   - Поддержка всех типов медиа

2. EncryptionTest:
   - Шифрование тестовых файлов
   - Проверка через обратную расшифровку
   - Генерация тестовых ключей

3. SidecarTest:
   - Генерация sidecar файлов
   - Проверка размеров MAC'ов
   - Сравнение с эталонными sidecar'ами

### Тестовые данные

1. Структура:
   ```
   tests/data/
   ├── AUDIO.{encrypted,original,key}
   ├── IMAGE.{encrypted,original,key}
   └── VIDEO.{encrypted,original,key,sidecar}
   ```

2. Форматы:
   - AUDIO: Opus в Ogg контейнере
   - IMAGE: JPEG
   - VIDEO: MP4 (ISO/IEC 14496-12)

## Безопасность

1. Криптографические гарантии:
   - Конфиденциальность: AES-256-CBC
   - Целостность: HMAC-SHA256
   - Уникальность ключей: HKDF

2. Защита от атак:
   - Padding oracle: PKCS7 + MAC
   - Replay: уникальные IV
   - Tampering: MAC для всего файла

## Производительность

1. Оптимизации:
   - Потоковая обработка
   - Эффективное управление памятью
   - Кэширование расширенных ключей

2. Размеры чанков:
   - Шифрование/расшифровка: 64KB
   - Буферизация: динамическая
   - MAC: 10 байт на чанк 