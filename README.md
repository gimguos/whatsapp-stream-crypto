# WhatsApp Stream Crypto Library

–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–ª—è —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è –∏ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏ –º–µ–¥–∏–∞ —Ñ–∞–π–ª–æ–≤ –≤ —Ñ–æ—Ä–º–∞—Ç–µ, —Å–æ–≤–º–µ—Å—Ç–∏–º–æ–º —Å WhatsApp. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ø–æ—Ç–æ–∫–æ–≤—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É –¥–∞–Ω–Ω—ã—Ö –∏ –ø—Ä–æ–≤–µ—Ä–∫—É —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏.

## ‚úÖ –°—Ç–∞—Ç—É—Å –ø—Ä–æ–µ–∫—Ç–∞

**–í—Å–µ –æ—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã —Ä–µ—à–µ–Ω—ã!** –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–∞ –∏ –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ.

**–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã:**
- ‚úÖ **AUDIO**: 16111 –±–∞–π—Ç - —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ **IMAGE**: 54211 –±–∞–π—Ç - —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ  
- ‚úÖ **VIDEO**: 393736 –±–∞–π—Ç - —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

## –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- ‚úÖ **–®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ/—Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ –º–µ–¥–∏–∞ —Ñ–∞–π–ª–æ–≤** (–∞—É–¥–∏–æ, –≤–∏–¥–µ–æ, –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è)
- ‚úÖ **–ü–æ—Ç–æ–∫–æ–≤–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö** —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –ø–∞–º—è—Ç–∏
- ‚úÖ **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö** —á–µ—Ä–µ–∑ HMAC-SHA256
- ‚úÖ **–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ sidecar —Ñ–∞–π–ª–æ–≤** –¥–ª—è –ø–æ—Ç–æ–∫–æ–≤–æ–≥–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
- ‚úÖ **–ü–æ–ª–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å** —Å —Ñ–æ—Ä–º–∞—Ç–æ–º —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è WhatsApp
- ‚úÖ **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π PHP** (hash_hkdf —Å PHP 7.1+)
- ‚úÖ **–ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø–∞–¥–¥–∏–Ω–≥–∞** –≤ AES-256-CBC —Ä–µ–∂–∏–º–µ

## –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

- PHP 7.1+ (–¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ `hash_hkdf()`)
- OpenSSL —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ
- Composer

## –£—Å—Ç–∞–Ω–æ–≤–∫–∞

```bash
composer require whatsapp/stream-crypto
```

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ —Ñ–∞–π–ª–∞

```php
use WhatsAppStream\Crypto\CryptoManager;
use WhatsAppStream\Enum\MediaType;
use WhatsAppStream\Stream\DecryptingStream;

$cryptoManager = new CryptoManager();
$encryptedStream = new \GuzzleHttp\Psr7\Stream(fopen('encrypted.mp4', 'r'));
$mediaKey = file_get_contents('media.key');

$decryptingStream = new DecryptingStream(
    $encryptedStream,
    $mediaKey,
    MediaType::VIDEO,
    $cryptoManager
);

$targetHandle = fopen('decrypted.mp4', 'wb');
while (!$decryptingStream->eof()) {
    fwrite($targetHandle, $decryptingStream->read(65536));
}
fclose($targetHandle);
$decryptingStream->close();
```

### –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞

```php
use WhatsAppStream\Stream\EncryptingStream;

$mediaKey = random_bytes(32);
$sourceStream = new \GuzzleHttp\Psr7\Stream(fopen('video.mp4', 'r'));

$encryptingStream = new EncryptingStream(
    $sourceStream,
    $mediaKey,
    MediaType::VIDEO,
    $cryptoManager
);

$targetHandle = fopen('encrypted.mp4', 'wb');
while (!$encryptingStream->eof()) {
    fwrite($targetHandle, $encryptingStream->read(65536));
}
fclose($targetHandle);
$encryptingStream->close();
```

## –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤

–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–∞–±–æ—Ä —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç—ã —Å —Ä–∞–∑–ª–∏—á–Ω—ã–º–∏ —Ç–∏–ø–∞–º–∏ –º–µ–¥–∏–∞ —Ñ–∞–π–ª–æ–≤:

```bash
# –û—Å–Ω–æ–≤–Ω—ã–µ —Ç–µ—Å—Ç—ã —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
./vendor/bin/phpunit tests/functional/DecryptionTest.php

# –í—Å–µ —Ç–µ—Å—Ç—ã –≤–∫–ª—é—á–∞—è —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ
./vendor/bin/phpunit tests/

# –û—Ç–¥–µ–ª—å–Ω—ã–µ —Ç–µ—Å—Ç—ã
php tests/functional/EncryptionTest.php     # –¢–µ—Å—Ç —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è
php tests/functional/SidecarTest.php       # –¢–µ—Å—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ sidecar
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç —Ç–µ—Å—Ç–æ–≤:**
```
Testing AUDIO decryption: ‚úÖ Successfully decrypted AUDIO file (16111 bytes)
Testing IMAGE decryption: ‚úÖ Successfully decrypted IMAGE file (54211 bytes)  
Testing VIDEO decryption: ‚úÖ Successfully decrypted VIDEO file (393736 bytes)

All tests passed successfully!
```

## üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

–í –¥–∞–Ω–Ω–æ–π –≤–µ—Ä—Å–∏–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –≤—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã:

1. ‚úÖ **HKDF —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è** ‚Üí –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è `hash_hkdf()` PHP 7.1+
2. ‚úÖ **–ü—Ä–æ–±–ª–µ–º–∞ —Å –ø–∞–º—è—Ç—å—é** ‚Üí MAC –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –ø–æ—Ç–æ–∫–æ–≤–æ –±–µ–∑ –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ–≥–æ —Ñ–∞–π–ª–∞
3. ‚úÖ **–û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–∞–¥–¥–∏–Ω–≥–∞** ‚Üí –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å `OPENSSL_ZERO_PADDING`
4. ‚úÖ **–ï–¥–∏–Ω–∞—è –ø–æ–¥–ø–∏—Å—å** ‚Üí HMAC –≤—ã—á–∏—Å–ª—è–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑ –¥–ª—è –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö
5. ‚úÖ **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–∞** ‚Üí IV –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ –Ω–∞—á–∞–ª–æ –≤ `EncryptingStream`

## üìñ –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

–í—Å–µ –ø—Ä–∏–º–µ—Ä—ã –∫–æ–¥–∞ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ —Ä–∞–±–æ—á–∏—Ö —Ç–µ—Å—Ç–∞—Ö:

### –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ —Ñ–∞–π–ª–æ–≤
**–ü–æ–ª–Ω—ã–π –ø—Ä–∏–º–µ—Ä:** [`tests/functional/DecryptionTest.php`](tests/functional/DecryptionTest.php)

```php
// –ë–∞–∑–æ–≤–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ DecryptingStream
$cryptoManager = new CryptoManager();
$encryptedStream = new Stream(fopen($encryptedPath, 'r'), $fileSize);
$mediaKey = file_get_contents($keyPath);

$decryptingStream = new DecryptingStream(
    $encryptedStream,
    $mediaKey,
    MediaType::VIDEO,
    $cryptoManager
);

// –ß–∏—Ç–∞–µ–º —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
$decryptedData = '';
while (!$decryptingStream->eof()) {
    $decryptedData .= $decryptingStream->read(65536);
}
```

### –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤
**–ü–æ–ª–Ω—ã–π –ø—Ä–∏–º–µ—Ä:** [`tests/functional/EncryptionTest.php`](tests/functional/EncryptionTest.php)

```php
// –ë–∞–∑–æ–≤–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ EncryptingStream
$mediaKey = random_bytes(32);
$sourceStream = new Stream(fopen($sourcePath, 'r'));

$encryptingStream = new EncryptingStream(
    $sourceStream,
    $mediaKey,
    MediaType::AUDIO,
    $cryptoManager
);

// –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
$encryptedData = '';
while (!$encryptingStream->eof()) {
    $encryptedData .= $encryptingStream->read(65536);
}
```

### –ì–µ–Ω–µ—Ä–∞—Ü–∏—è Sidecar —Ñ–∞–π–ª–æ–≤
**–ü–æ–ª–Ω—ã–π –ø—Ä–∏–º–µ—Ä:** [`tests/functional/SidecarTest.php`](tests/functional/SidecarTest.php)

```php
// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è sidecar –¥–ª—è –ø–æ—Ç–æ–∫–æ–≤–æ–≥–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
$sidecarGenerator = new SidecarGenerator($cryptoManager);
$encryptedStream = new Stream(fopen($encryptedPath, 'r'));

$sidecarData = $sidecarGenerator->generate(
    $encryptedStream,
    $mediaKey,
    MediaType::VIDEO
);

// –ö–∞–∂–¥—ã–µ 10 –±–∞–π—Ç = MAC –¥–ª—è 64KB —á–∞–Ω–∫–∞
$macCount = strlen($sidecarData) / 10;
```

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
src/
  ‚îú‚îÄ‚îÄ Crypto/
  ‚îÇ   ‚îî‚îÄ‚îÄ CryptoManager.php      # –ö—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
  ‚îú‚îÄ‚îÄ Stream/
  ‚îÇ   ‚îú‚îÄ‚îÄ DecryptingStream.php   # –ü–æ—Ç–æ–∫ –¥–ª—è —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏
  ‚îÇ   ‚îî‚îÄ‚îÄ EncryptingStream.php   # –ü–æ—Ç–æ–∫ –¥–ª—è —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è
  ‚îî‚îÄ‚îÄ Enum/
      ‚îî‚îÄ‚îÄ MediaType.php          # –¢–∏–ø—ã –º–µ–¥–∏–∞ —Ñ–∞–π–ª–æ–≤

tests/
  ‚îú‚îÄ‚îÄ data/                      # –¢–µ—Å—Ç–æ–≤—ã–µ —Ñ–∞–π–ª—ã
  ‚îî‚îÄ‚îÄ functional/                # –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ç–µ—Å—Ç—ã
```

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è AES-256-CBC –¥–ª—è —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è
- HMAC-SHA256 –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏  
- HKDF –¥–ª—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è –∫–ª—é—á–µ–π
- –í—Å–µ –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è —á–µ—Ä–µ–∑ –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ OpenSSL

## –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

- –ü–æ—Ç–æ–∫–æ–≤–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–º —Ä–∞–∑–º–µ—Ä–æ–º –±—É—Ñ–µ—Ä–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 64KB)
- –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ñ–∞–π–ª–æ–≤ –ª—é–±–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞

## –õ–∏—Ü–µ–Ω–∑–∏—è

MIT

## –ü–æ–¥—Ä–æ–±–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã –∏ –ø—Ä–∏–Ω—Ü–∏–ø–æ–≤ —Ä–∞–±–æ—Ç—ã –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –¥–æ—Å—Ç—É–ø–Ω–æ –≤ —Ñ–∞–π–ª–µ [ARCHITECTURE.md](ARCHITECTURE.md). 